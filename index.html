<!DOCTYPE html>
<html>
	<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<title>title</title>
	<meta name="author" content="TikiMari">
	<meta name="description" content="Custom clothing">
	<meta name="keywords" content="clothing">
	<link rel="stylesheet" type="text/css" href="index.css">

	</style>
	</head>
	<body>

		<div id="menu-space"></div>
		<div id="design-space" class="wh100"></div>

		<script src="jquery-3.2.1.min.js" type="text/javascript"></script>
		<script src="datatree.js"></script>
		<script>
			$( document ).ready(function() {
				var menuItems = [];
				var menuTree = {};

				// Get URL
				var getParams = getSerializedGetParams();
				var code = getParams.design;
				var menu = getParams.menu; // [null, categories, (other)]
				// Disable redirect until building of design works.
				// if (!code) window.location.replace("?design=m0<s0<tt0>>");

				// Convert data
				var designTree = designCodeToTree(code);
				var cats = getAllActiveCategories(designTree);
				var designList = getAllActiveDesigns(designTree);
				var availableItems = getChildrenOfActiveCategory(designTree, cats[2]);
				console.log(cats)
				console.log(designList);
				console.log(availableItems)

				// Display menu
				var html = "";
				if (menu)
					html = getDesignsMenuHTML(availableItems);
				else
					html += getCatsMenuHTML(cats);
				document.getElementById('menu-space').innerHTML = html;

			});

			function getCatsMenuHTML(cats) {
				var html = "";
				html += cats.join(", ");
				return html;
			}

			function getDesignsMenuHTML(designList) {
				var html = "<ul>";
				for (var i = 0; i < designList.length; i++) {
					html += designList[i].name + ", ";
				}
				html += "</ul>";
				return html;
			}

			function getChildrenOfActiveCategory(designTree, cat) {
				var keys = Object.keys(designTree);
				var designList = getAllActiveDesigns(designTree);
				var childrenOfCategory = [];
				for (var i = 0; i < designList.length; i++) {
					var dli = designList[i];
					var kids = datatree.designs[dli].children;
					for (var j = 0; j < kids.length; j++) {
						var kid = datatree.designs[kids[j]];
						if (kid.category === cat)
							childrenOfCategory.push(kid);
					}
				}
				return childrenOfCategory;
			}

			function getAllActiveDesigns(designTree) {
				var designs = [];
				var keys = Object.keys(designTree);
				for (var i = 0; i < keys.length; i++) {
					designs.push(keys[i]);
					var d = designTree[keys[i]];
					if (d.childrenActive)
						designs = designs.concat(getAllActiveDesigns(d.childrenActive));
				}
				return designs;
			}

			function getAllActiveCategories(designTree) {
				var cats = [];
				var keys = Object.keys(designTree);
				for (var i = 0; i < keys.length; i++) {
					var d = designTree[keys[i]];
					cats.push(d.category);
					if (d.childrenActive) cats = cats.concat(getAllActiveCategories(d.childrenActive));
				}
				var uniqueCats = cats.filter(function(item, pos, self) {
					return self.indexOf(item) == pos;
				});
				return uniqueCats;
			}

			function cloneObject(obj) {
				// https://stackoverflow.com/questions/122102/what-is-the-most-efficient-way-to-deep-clone-an-object-in-javascript
				return JSON.parse(JSON.stringify(obj));
			}

			function designCodeToTree(code) {
				var designTree = {};
				var codeArray = designCodeToArray(code);
				var lastC = "";
				for (var i = 0; i < codeArray.length; i++) {
					var c = codeArray[i];
					if (c[0] === "<") {
						designTree[lastC].childrenActive = designCodeToTree(c.slice(1, c.length-1));
						i++;
					} else if (isNaN(parseInt(c))) {
						designTree[c] = datatree.designs[c];
						lastC = c;
					}
				}
				return designTree;
			}

			function designCodeToArray(code) {
				return code.split(/(\d|<.*>)/g).filter(Boolean); // filter removes empty strings
			}

			function designTreeToCode(dtree) {
				var code = "";
				var keys = Object.keys(dtree);
				for (var i = 0; i < keys.length; i++) {
					code += keys[i] + "0";
					var kids = dtree[keys].childrenActive;
					if (kids) {
						for (var j = 0; j < kids.length; j++) {
							code += "<";
							code += designTreeToCode(kids[j]);
							code += ">";
						}
					}
				}
				return code;
			}

			function getGetParameter(parameterName) {
				var result = null,
					tmp = [];
				location.search
					.substr(1)
					.split("&")
					.forEach(function (item) {
					  tmp = item.split("=");
					  if (tmp[0] === parameterName) result = decodeURIComponent(tmp[1]);
					});
				return result;
			}

			function getSerializedGetParams() {
				var result = {};
				var tmp = [];
				location.search.substr(1).split("&").forEach(function (item) {
					tmp = item.split("=");
					result[tmp[0]] = decodeURIComponent(tmp[1]);
				});
				return result;
			}
		</script>

	</body>
</html>